<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Чат</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 via-blue-200 to-blue-300 flex justify-center pt-10">

<div class="flex flex-col h-[700px] w-96 bg-white rounded-3xl shadow-2xl overflow-hidden">
  <div id="chat-header" class="p-4 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold text-lg"></div>
  <div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gradient-to-b from-blue-50 to-blue-100"></div>
  <div class="p-3 border-t border-gray-200 flex">
    <input id="message-input" class="flex-1 px-3 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Написать сообщение...">
    <button id="send-btn" class="ml-2 px-4 py-2 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl hover:from-blue-500 hover:to-blue-700 transition">Отправить</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://kjjzlkbyzlpkbieboaoo.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc'
const supabase = createClient(supabaseUrl, supabaseKey)

const { data: { user } } = await supabase.auth.getUser()
const params = new URLSearchParams(window.location.search)
const friendId = params.get('f')
const friendName = params.get('n')
document.getElementById('chat-header').innerText = friendName

const chatMessages = document.getElementById('chat-messages')
const input = document.getElementById('message-input')
const sendBtn = document.getElementById('send-btn')

// Загрузка сообщений
async function loadMessages() {
  const { data } = await supabase.from('messages')
    .select('*')
    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${user.id})`)
    .order('created_at', { ascending: true })

  chatMessages.innerHTML = data.map(msg => {
    const isMe = msg.sender_id === user.id
    const senderName = isMe ? 'Вы' : friendName
    return `<div class="p-2 rounded-xl shadow max-w-xs ${isMe ? 'bg-blue-200 ml-auto' : 'bg-white'}">
      <div class="text-sm font-bold">${senderName}</div>
      <div>${msg.content}</div>
    </div>`
  }).join('')
  chatMessages.scrollTop = chatMessages.scrollHeight
}

// Отправка сообщений
sendBtn.addEventListener('click', async () => {
  const content = input.value.trim()
  if (!content) return
  await supabase.from('messages').insert([{ sender_id: user.id, receiver_id: friendId, content }])
  input.value = ''
})

// Подписка на новые сообщения
supabase.channel('messages')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
    const msg = payload.new
    if ((msg.sender_id === user.id && msg.receiver_id === friendId) || (msg.sender_id === friendId && msg.receiver_id === user.id)) {
      loadMessages()
    }
  })
  .subscribe()

loadMessages()
</script>
</body>
</html>
