<div>
  <input id="friend-input" placeholder="Введите ник" />
  <button id="send-request">Добавить друга</button>
</div>
<div id="friends-list"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient('https://kjjzlkbyzlpkbieboaoo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc')

const { data: { user } } = await supabase.auth.getUser()
const friendsList = document.getElementById('friends-list')

// Загрузка друзей
async function loadFriends() {
  const { data } = await supabase.from('friends')
    .select('friend_id, users(username)')
    .eq('user_id', user.id)
    .leftJoin('users', 'friends.friend_id=users.id')
  friendsList.innerHTML = data.map(f => `<div>${f.users.username}</div>`).join('')
}

// Добавление друга с автоматическим принятием
document.getElementById('send-request').onclick = async () => {
  const nickname = document.getElementById('friend-input').value.trim()
  if (!nickname) return alert('Введите ник')

  // Находим пользователя
  const { data: friendUser } = await supabase.from('users').select('*').eq('username', nickname).single()
  if (!friendUser) return alert('Пользователь не найден')
  if (friendUser.id === user.id) return alert('Нельзя добавить себя')

  // Проверяем, есть ли уже заявка в обратную сторону
  const { data: reverse } = await supabase.from('friend_requests')
    .select('*')
    .eq('sender_id', friendUser.id)
    .eq('receiver_id', user.id)
    .eq('status', 'pending')
    .single()

  if (reverse) {
    // Если есть — автоматически добавляем в друзья
    await supabase.from('friends').upsert([
      { user_id: user.id, friend_id: friendUser.id },
      { user_id: friendUser.id, friend_id: user.id }
    ])
    // Обновляем статус заявки
    await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', reverse.id)
    alert(`Вы и ${nickname} теперь друзья!`)
  } else {
    // Иначе создаём обычную заявку
    await supabase.from('friend_requests').insert({ sender_id: user.id, receiver_id: friendUser.id })
    alert('Заявка отправлена!')
  }
  loadFriends()
}

loadFriends()
</script>
