<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Друзья</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 via-blue-200 to-blue-300 flex justify-center pt-10">

<div class="flex h-[700px] w-[1000px] bg-white rounded-3xl shadow-2xl overflow-hidden">
  
  <!-- Левая колонка: поиск и друзья -->
  <div class="w-1/2 border-r border-gray-200 flex flex-col">
    <div class="p-4 bg-gradient-to-r from-blue-500 to-blue-700 text-white flex justify-between items-center font-bold text-lg">
      <span>Друзья</span>
      <button id="logout" class="px-2 py-1 bg-white text-blue-600 rounded hover:bg-gray-100">Выйти</button>
    </div>

    <!-- Поиск пользователей -->
    <div class="p-3 border-b border-gray-200 flex">
      <input id="friend-input" type="text" placeholder="Поиск пользователя..." class="flex-1 border rounded-full px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button id="send-request" class="ml-2 px-3 py-1 rounded-full bg-gradient-to-r from-purple-400 to-purple-600 text-white hover:from-purple-500 hover:to-purple-700 transition">Найти</button>
    </div>

    <!-- Список друзей -->
    <div class="flex-1 overflow-y-auto p-3 space-y-2 bg-gradient-to-b from-blue-50 to-blue-100" id="friends-list"></div>
  </div>

  <!-- Правая колонка: заявки в друзья -->
  <div class="w-1/2 flex flex-col">
    <div class="p-4 bg-gradient-to-r from-green-400 to-green-600 text-white font-bold text-lg">Приглашения в друзья</div>
    <div id="requests-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gradient-to-b from-green-50 to-green-100"></div>
  </div>

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://kjjzlkbyzlpkbieboaoo.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc'
const supabase = createClient(supabaseUrl, supabaseKey)

const { data: { user } } = await supabase.auth.getUser()
const requestsList = document.getElementById('requests-list')
const friendsList = document.getElementById('friends-list')

// Загрузка заявок
async function loadRequests() {
  const { data, error } = await supabase.from('friend_requests')
    .select('id,sender_id,users(username)')
    .eq('receiver_id', user.id)
    .eq('status', 'pending')
    .leftJoin('users', 'friend_requests.sender_id=users.id')  // убедись, что имя таблицы 'users'
  
  if (error) return console.log(error)
  requestsList.innerHTML = data.map(r => `
    <div class="flex justify-between items-center p-3 rounded-xl shadow bg-white">
      <span>${r.users.username} хочет добавить вас</span>
      <div class="flex space-x-2">
        <button onclick="handleRequest(${r.id}, 'accepted')" class="px-3 py-1 rounded-xl bg-gradient-to-r from-green-400 to-green-600 text-white hover:from-green-500 hover:to-green-700 transition">Принять</button>
        <button onclick="handleRequest(${r.id}, 'rejected')" class="px-3 py-1 rounded-xl bg-gradient-to-r from-red-400 to-red-600 text-white hover:from-red-500 hover:to-red-700 transition">Отклонить</button>
      </div>
    </div>
  `).join('')
}

// Обработка заявки
window.handleRequest = async (id, status) => {
  await supabase.from('friend_requests').update({ status }).eq('id', id)
  if (status === 'accepted') {
    const { data: req } = await supabase.from('friend_requests').select('*').eq('id', id).single()
    await supabase.from('friends').upsert([
      { user_id: req.sender_id, friend_id: req.receiver_id },
      { user_id: req.receiver_id, friend_id: req.sender_id }
    ])
  }
  loadRequests()
  loadFriends()
}

// Загрузка друзей
async function loadFriends() {
  const { data } = await supabase.from('friends')
    .select('friend_id, users(username)')
    .eq('user_id', user.id)
    .leftJoin('users', 'friends.friend_id=users.id')

  friendsList.innerHTML = data.map(f => `
    <div onclick="openChat('${f.friend_id}','${f.users.username}')" class="cursor-pointer flex justify-between items-center p-3 rounded-xl shadow bg-white hover:bg-blue-100">
      <span>${f.users.username}</span>
      <button onclick="deleteFriend('${f.friend_id}');event.stopPropagation();" class="px-2 py-1 rounded-xl bg-red-400 text-white hover:bg-red-500 transition">Удалить</button>
    </div>
  `).join('')
}

// Удаление друга
window.deleteFriend = async (friendId) => {
  await supabase.from('friends').delete().or(`and(user_id.eq.${user.id},friend_id.eq.${friendId}),and(user_id.eq.${friendId},friend_id.eq.${user.id})`)
  loadFriends()
}

// Открытие чата
window.openChat = (friendId, friendName) => {
  location.href = `chat.html?f=${friendId}&n=${friendName}`
}

// Поиск пользователя и отправка заявки
document.getElementById('send-request').onclick = async () => {
  const username = document.getElementById('friend-input').value.trim()
  if (!username) return alert('Введите ник')

  const { data: friendUser, error } = await supabase.from('users').select('*').eq('username', username).single()
  if (error || !friendUser) return alert('Пользователь не найден')
  if (friendUser.id === user.id) return alert('Нельзя добавить себя')

  const { data: exists } = await supabase.from('friend_requests')
    .select('*')
    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${friendUser.id}),and(sender_id.eq.${friendUser.id},receiver_id.eq.${user.id})`)
    .eq('status','pending')
    .single()

  if (exists) return alert('Заявка уже отправлена')

  await supabase.from('friend_requests').insert({ sender_id: user.id, receiver_id: friendUser.id })
  alert('Заявка отправлена!')
  loadRequests()
}

// Выход
document.getElementById('logout').onclick = async () => {
  await supabase.auth.signOut()
  location.href = 'index.html'
}

// Инициализация
loadRequests()
loadFriends()
</script>
</body>
</html>
