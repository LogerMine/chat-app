<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Друзья и Чат</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-100 via-purple-200 to-purple-300 min-h-screen p-6">

<h1 class="text-2xl font-bold mb-4">Привет, <span id="my-name"></span>!</h1>

<!-- Добавление друга -->
<div class="mb-6">
  <input id="friend-input" placeholder="Введите ник друга" class="border px-3 py-2 rounded-xl w-1/2 mr-2">
  <button id="send-request" class="bg-green-400 px-3 py-2 rounded-xl hover:bg-green-500">Добавить друга</button>
</div>

<!-- Список друзей -->
<div id="friends-list" class="mb-6"></div>

<!-- Чат -->
<div id="chat-container" class="border p-4 rounded-xl bg-white max-w-lg"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient('https://kjjzlkbyzlpkbieboaoo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc')
const userId = localStorage.getItem('user_id')
const username = localStorage.getItem('username')
document.getElementById('my-name').innerText = username

const friendsList = document.getElementById('friends-list')
const chatContainer = document.getElementById('chat-container')

// Загрузка друзей
async function loadFriends() {
  const { data: friends } = await supabase.from('friends')
    .select('friend_id, users(username)')
    .eq('user_id', userId)
    .leftJoin('users', 'friends.friend_id=users.id')

  if (!friends) return
  friendsList.innerHTML = friends.map(f => `<div>${f.users.username}</div>`).join('')
}

// Добавление друга с авто-принятием
document.getElementById('send-request').onclick = async () => {
  const nickname = document.getElementById('friend-input').value.trim()
  if (!nickname) return alert('Введите ник')

  const { data: friendUser } = await supabase.from('users')
    .select('*')
    .eq('username', nickname)
    .maybeSingle()

  if (!friendUser) return alert('Пользователь не найден')
  if (friendUser.id === userId) return alert('Нельзя добавить себя')

  // Проверяем обратную заявку
  const { data: reverse } = await supabase.from('friend_requests')
    .select('*')
    .eq('sender_id', friendUser.id)
    .eq('receiver_id', userId)
    .eq('status', 'pending')
    .maybeSingle()

  if (reverse) {
    // Авто-принятие
    await supabase.from('friends').upsert([
      { user_id: userId, friend_id: friendUser.id },
      { user_id: friendUser.id, friend_id: userId }
    ])
    await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', reverse.id)
    alert(`Вы и ${nickname} теперь друзья!`)
  } else {
    await supabase.from('friend_requests').insert({ sender_id: userId, receiver_id: friendUser.id })
    alert('Заявка отправлена!')
  }

  loadFriends()
}

loadFriends()
</script>
</body>
</html>
