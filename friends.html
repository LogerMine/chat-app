<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeraChat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  #chat-messages {
    display: flex;
    flex-direction: column-reverse;
    overflow-y: scroll;
    height: calc(100% - 60px);
    padding: 10px;
  }
  .msg-self { background: linear-gradient(90deg, #a5f3fc, #38bdf8); align-self: flex-end; }
  .msg-friend { background: linear-gradient(90deg, #fca5a5, #f87171); align-self: flex-start; }
  .msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; margin: 4px 0; color: white; font-weight: 500; }
</style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-purple-200 to-purple-300 min-h-screen flex flex-col">

<h1 class="text-2xl font-bold mb-4 text-center">Привет, <span id="my-name"></span>!</h1>

<div class="flex flex-1 gap-4 h-[80vh]">

  <!-- Левая колонка: друзья -->
  <div class="w-1/3 bg-white rounded-2xl shadow flex flex-col p-4">
    <input id="friend-input" placeholder="Найти или добавить друга" class="border mb-3 px-3 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
    <button id="send-request" class="bg-green-400 px-3 py-2 rounded-xl hover:bg-green-500 mb-3">Добавить друга</button>
    <div id="friends-list" class="flex-1 overflow-y-auto"></div>
  </div>

  <!-- Правая колонка: чат -->
  <div class="flex-1 bg-white rounded-2xl shadow flex flex-col p-4">
    <div id="chat-header" class="font-bold mb-2">Выберите друга для чата</div>
    <div id="chat-messages" class="flex-1 flex flex-col-reverse mb-2"></div>
    <div class="flex gap-2">
      <input id="chat-input" type="text" placeholder="Введите сообщение..." class="border flex-1 px-3 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      <button id="send-btn" class="bg-blue-500 px-4 py-2 rounded-xl hover:bg-blue-600 text-white">Отправить</button>
    </div>
  </div>

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://kjjzlkbyzlpkbieboaoo.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc'
)

const userId = localStorage.getItem('user_id')
const username = localStorage.getItem('username')
document.getElementById('my-name').innerText = username

let selectedFriendId = null
let selectedFriendName = null

// Загрузка друзей
async function loadFriends() {
  const { data: friends } = await supabase.from('friends')
    .select('friend_id, users(username)')
    .eq('user_id', userId)
    .leftJoin('users', 'friends.friend_id=users.id')

  const container = document.getElementById('friends-list')
  container.innerHTML = ''
  if (!friends) return

  friends.forEach(f => {
    const div = document.createElement('div')
    div.className = 'p-2 rounded-xl hover:bg-purple-100 cursor-pointer'
    div.innerText = f.users.username
    div.onclick = () => selectFriend(f.friend_id, f.users.username)
    container.appendChild(div)
  })
}

// Выбор друга для чата
function selectFriend(id, name) {
  selectedFriendId = id
  selectedFriendName = name
  document.getElementById('chat-header').innerText = name
  loadMessages()
}

// Загрузка сообщений между пользователем и выбранным другом
async function loadMessages() {
  if (!selectedFriendId) return
  const { data: messages } = await supabase.from('messages')
    .select('*')
    .or(
      `(sender_id.eq.${userId},receiver_id.eq.${selectedFriendId}),` +
      `(sender_id.eq.${selectedFriendId},receiver_id.eq.${userId})`
    )
    .order('created_at', { ascending: true })

  const chat = document.getElementById('chat-messages')
  chat.innerHTML = ''
  messages.forEach(msg => {
    const div = document.createElement('div')
    div.className = 'msg ' + (msg.sender_id === userId ? 'msg-self' : 'msg-friend')
    div.innerText = (msg.sender_id === userId ? 'Вы: ' : selectedFriendName + ': ') + msg.content
    chat.appendChild(div)
  })
}

// Отправка сообщения
document.getElementById('send-btn').onclick = async () => {
  const input = document.getElementById('chat-input')
  const content = input.value.trim()
  if (!content || !selectedFriendId) return
  await supabase.from('messages').insert([{ sender_id: userId, receiver_id: selectedFriendId, content }])
  input.value = ''
  loadMessages()
}

// Добавление друга
document.getElementById('send-request').onclick = async () => {
  const nickname = document.getElementById('friend-input').value.trim()
  if (!nickname) return alert('Введите ник друга')
  const { data: friendUser } = await supabase.from('users')
    .select('*')
    .eq('username', nickname)
    .maybeSingle()
  if (!friendUser) return alert('Пользователь не найден')
  if (friendUser.id === userId) return alert('Нельзя добавить себя')

  // Добавляем в friends сразу обе записи
  await supabase.from('friends').insert([
    { user_id: userId, friend_id: friendUser.id },
    { user_id: friendUser.id, friend_id: userId }
  ])
  loadFriends()
  alert(`${nickname} добавлен в друзья!`)
}

loadFriends()
</script>
</body>
</html>
