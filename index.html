<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Друзья чат Supabase</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 via-blue-200 to-blue-300 h-screen flex items-center justify-center">

<div class="bg-white rounded-2xl shadow-xl w-96 h-[600px] flex flex-col overflow-hidden">
  <!-- Шапка -->
  <div class="flex items-center p-4 bg-gradient-to-r from-blue-400 to-blue-600 text-white">
    <img src="logo.png" alt="Лого" class="w-10 h-10 mr-3 rounded-full">
    <h1 class="text-xl font-bold">Чат с друзьями</h1>
  </div>

  <!-- Список друзей -->
  <div class="p-2 border-b border-gray-200 flex">
    <input id="friend-input" type="text" placeholder="Поиск друга по нику..." class="flex-1 border rounded-full px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <button id="add-friend-btn" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600">Добавить</button>
  </div>

  <!-- Чат -->
  <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gradient-to-b from-blue-50 to-blue-100"></div>

  <!-- Поле ввода -->
  <div class="p-4 bg-white flex items-center border-t border-gray-200">
    <input id="message-input" type="text" placeholder="Написать сообщение..." class="flex-1 border rounded-full px-4 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <button id="send-btn" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600">Отправить</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// ---------------------------
// Вставь свои данные Supabase
// ---------------------------
const supabaseUrl = 'https://kjjzlkbyzlpkbieboaoo.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqanpsa2J5emxwa2JpZWJvYW9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjMxNTQsImV4cCI6MjA3ODA5OTE1NH0.MdoZunGrL5q-UTeT-Rwbapei7d0msNt0g6LG7_rHrHc'
const supabase = createClient(supabaseUrl, supabaseKey)

// ---------------------------
// Временный пользователь (заменить на авторизацию)
// ---------------------------
let currentUser = { id: '00000000-0000-0000-0000-000000000000', username: 'You' }
let currentFriend = null

const chatContainer = document.getElementById('chat-messages')
const inputField = document.getElementById('message-input')
const sendButton = document.getElementById('send-btn')
const friendInput = document.getElementById('friend-input')
const addFriendBtn = document.getElementById('add-friend-btn')

// ---------------------------
// Добавление друга по нику
// ---------------------------
addFriendBtn.addEventListener('click', async () => {
  const friendName = friendInput.value.trim()
  if (!friendName) return

  // Получаем id друга
  const { data: users } = await supabase.from('users').select('*').eq('username', friendName).limit(1)
  if (!users.length) return alert('Пользователь не найден')
  const friend = users[0]
  currentFriend = friend

  // Добавляем дружбу (только если еще нет)
  await supabase.from('friends').upsert([
    { user_id: currentUser.id, friend_id: friend.id },
    { user_id: friend.id, friend_id: currentUser.id }
  ])

  chatContainer.innerHTML = ''
  loadMessages()
})

// ---------------------------
// Загрузка сообщений между друзьями
// ---------------------------
async function loadMessages() {
  if (!currentFriend) return

  const { data } = await supabase
    .from('messages')
    .select('*')
    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentFriend.id}),and(sender_id.eq.${currentFriend.id},receiver_id.eq.${currentUser.id})`)
    .order('created_at', { ascending: true })

  chatContainer.innerHTML = data.map(msg => renderMessage(msg)).join('')
  chatContainer.scrollTop = chatContainer.scrollHeight
}

// ---------------------------
// Рендер сообщения
// ---------------------------
function renderMessage(msg) {
  const isMe = msg.sender_id === currentUser.id
  return `
    <div class="p-2 rounded-lg shadow max-w-xs ${isMe ? 'bg-blue-200 ml-auto' : 'bg-white'}">
      <div>${msg.content}</div>
    </div>
  `
}

// ---------------------------
// Отправка сообщений
// ---------------------------
sendButton.addEventListener('click', async () => {
  if (!currentFriend) return alert('Сначала выбери друга')

  const content = inputField.value.trim()
  if (!content) return

  await supabase.from('messages').insert([
    { sender_id: currentUser.id, receiver_id: currentFriend.id, content }
  ])
  inputField.value = ''
})

// ---------------------------
// Подписка на новые сообщения в реальном времени
// ---------------------------
supabase
  .channel('messages')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
    const msg = payload.new
    if (!currentFriend) return
    if ((msg.sender_id === currentUser.id && msg.receiver_id === currentFriend.id) ||
        (msg.sender_id === currentFriend.id && msg.receiver_id === currentUser.id)) {
      chatContainer.innerHTML += renderMessage(msg)
      chatContainer.scrollTop = chatContainer.scrollHeight
    }
  })
  .subscribe()
</script>

</body>
</html>
